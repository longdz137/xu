<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dịch vụ nạp xu TikTok chính hãng, giá rẻ, an toàn và nhanh chóng. Nạp coin TikTok với nhiều ưu đãi hấp dẫn.">
    <meta name="keywords" content="nạp xu tiktok, nap coin tiktok, mua xu tiktok, giá xu tiktok, dịch vụ tiktok">
    <title>Dịch Vụ Nạp Xu TikTok Chính Hãng | Giá Rẻ & An Toàn</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        /* [Giữ nguyên tất cả CSS từ phiên bản trước] */
        /* ... */

        /* Thêm CSS cho phần lịch sử đơn hàng */
        .order-history {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 60px;
        }

        .order-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .order-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .order-id {
            font-weight: bold;
            color: var(--primary-color);
        }

        .order-date {
            color: #666;
            font-size: 14px;
        }

        .order-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #FFF3CD;
            color: #856404;
        }

        .status-completed {
            background-color: #D4EDDA;
            color: #155724;
        }

        .status-cancelled {
            background-color: #F8D7DA;
            color: #721C24;
        }

        .order-details {
            display: none;
            margin-top: 15px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .order-total {
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
        }

        .view-details {
            color: var(--primary-color);
            cursor: pointer;
            font-size: 14px;
            display: inline-block;
            margin-top: 10px;
        }

        .no-orders {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .history-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .history-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .history-tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- [Giữ nguyên header, hero section, pricing section...] -->
    <!-- ... -->

    <!-- Thêm section lịch sử đơn hàng -->
    <section id="order-history" class="container" style="display: none;">
        <h2 class="section-title">Lịch Sử Đơn Hàng</h2>
        
        <div class="history-tabs">
            <div class="history-tab active" data-status="all">Tất cả</div>
            <div class="history-tab" data-status="pending">Chờ xử lý</div>
            <div class="history-tab" data-status="completed">Hoàn thành</div>
            <div class="history-tab" data-status="cancelled">Đã hủy</div>
        </div>
        
        <div class="order-history">
            <div id="orders-container">
                <!-- Đơn hàng sẽ được hiển thị ở đây -->
                <div class="no-orders">
                    <i class="fas fa-box-open" style="font-size: 50px; margin-bottom: 15px;"></i>
                    <p>Bạn chưa có đơn hàng nào</p>
                </div>
            </div>
        </div>
    </section>

    <!-- [Giữ nguyên các section khác...] -->
    <!-- ... -->

    <!-- [Giữ nguyên các modal...] -->
    <!-- ... -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // [Giữ nguyên các biến và hàm cơ bản...]
        
        // Thêm tab lịch sử đơn hàng vào navigation
        $(document).ready(function() {
            $('nav ul').append('<li><a href="#order-history" id="history-link">Lịch Sử Đơn Hàng</a></li>');
            
            // Kiểm tra nếu có đơn hàng trong localStorage thì hiển thị tab lịch sử
            if (localStorage.getItem('orders')) {
                $('#history-link').show();
            } else {
                $('#history-link').hide();
            }
        });

        // FormSubmit integration
        $('#checkout-form').attr('action', 'https://formsubmit.co/your-email@example.com');
        $('#checkout-form').attr('method', 'POST');
        
        // Thêm input ẩn cho FormSubmit
        function prepareFormSubmit(orderData) {
            // Tạo các input ẩn chứa dữ liệu đơn hàng
            let form = $('#checkout-form');
            
            // Xóa các input ẩn cũ nếu có
            form.find('input[name^="_"]').remove();
            
            // Thêm các thông tin cần thiết cho FormSubmit
            form.append('<input type="hidden" name="_subject" value="[Nạp Xu TikTok] Đơn hàng mới #' + orderData.orderId + '">');
            form.append('<input type="hidden" name="_template" value="table">');
            form.append('<input type="hidden" name="_next" value="https://yourwebsite.com/thank-you.html">');
            form.append('<input type="hidden" name="_captcha" value="false">');
            
            // Thêm dữ liệu đơn hàng
            form.append('<input type="hidden" name="Mã đơn hàng" value="' + orderData.orderId + '">');
            form.append('<input type="hidden" name="Tên khách hàng" value="' + orderData.customer.name + '">');
            form.append('<input type="hidden" name="Email" value="' + orderData.customer.email + '">');
            form.append('<input type="hidden" name="Số điện thoại" value="' + orderData.customer.phone + '">');
            form.append('<input type="hidden" name="ID TikTok" value="' + orderData.tiktokId + '">');
            form.append('<input type="hidden" name="Phương thức thanh toán" value="' + getPaymentMethodName(orderData.paymentMethod) + '">');
            form.append('<input type="hidden" name="Ghi chú" value="' + (orderData.note || 'Không có') + '">');
            form.append('<input type="hidden" name="Ngày đặt hàng" value="' + orderData.date + '">');
            
            // Thêm thông tin sản phẩm
            orderData.items.forEach((item, index) => {
                form.append('<input type="hidden" name="Sản phẩm ' + (index + 1) + '" value="' + item.name + ' - ' + item.quantity + ' x ' + formatPrice(item.price) + 'đ">');
            });
            
            form.append('<input type="hidden" name="Tổng cộng" value="' + formatPrice(orderData.total) + 'đ">');
        }

        // Confirm payment với FormSubmit
        $('#confirm-payment').click(function() {
            // Validate form
            if ($('#checkout-form')[0].checkValidity()) {
                // Show loading state
                $(this).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...').prop('disabled', true);
                
                // Prepare order data
                const orderId = generateOrderId();
                const orderData = {
                    orderId: orderId,
                    customer: {
                        name: $('#customer-name').val(),
                        phone: $('#customer-phone').val(),
                        email: $('#customer-email').val()
                    },
                    tiktokId: $('#tiktok-id').val(),
                    items: cart,
                    paymentMethod: $('input[name="payment-method"]:checked').val(),
                    note: $('#customer-note').val(),
                    total: cart.reduce((total, item) => total + (item.price * item.quantity), 0),
                    date: new Date().toLocaleString('vi-VN'),
                    status: 'pending'
                };
                
                // Chuẩn bị dữ liệu cho FormSubmit
                prepareFormSubmit(orderData);
                
                // Lưu đơn hàng vào localStorage
                saveOrder(orderData);
                
                // Gửi form thực tế
                $('#checkout-form').submit();
                
                // Hiển thị thông báo thành công
                $('#order-id').text(orderData.orderId);
                $('#checkout-modal').fadeOut(function() {
                    openModal('#success-modal');
                    
                    // Clear cart
                    cart = [];
                    updateCart();
                    localStorage.removeItem('cart');
                    
                    // Reset form
                    $('#checkout-form')[0].reset();
                    
                    // Hiển thị tab lịch sử
                    $('#history-link').show();
                });
                
                // Reset button state
                $('#confirm-payment').html('Xác nhận thanh toán').prop('disabled', false);
            } else {
                // Show validation errors
                $('#checkout-form')[0].reportValidity();
            }
        });

        // Lưu đơn hàng vào localStorage
        function saveOrder(orderData) {
            let orders = [];
            
            if (localStorage.getItem('orders')) {
                orders = JSON.parse(localStorage.getItem('orders'));
            }
            
            orders.push(orderData);
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // Hiển thị lịch sử đơn hàng
        function loadOrderHistory(status = 'all') {
            if (!localStorage.getItem('orders')) {
                $('#orders-container').html(`
                    <div class="no-orders">
                        <i class="fas fa-box-open" style="font-size: 50px; margin-bottom: 15px;"></i>
                        <p>Bạn chưa có đơn hàng nào</p>
                    </div>
                `);
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('orders'));
            let filteredOrders = orders;
            
            if (status !== 'all') {
                filteredOrders = orders.filter(order => order.status === status);
            }
            
            if (filteredOrders.length === 0) {
                $('#orders-container').html(`
                    <div class="no-orders">
                        <i class="fas fa-box-open" style="font-size: 50px; margin-bottom: 15px;"></i>
                        <p>Không tìm thấy đơn hàng nào</p>
                    </div>
                `);
                return;
            }
            
            let html = '';
            
            // Sắp xếp đơn hàng mới nhất lên đầu
            filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredOrders.forEach(order => {
                let itemsHtml = '';
                let total = 0;
                
                order.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    
                    itemsHtml += `
                        <div class="order-item">
                            <span>${item.name} (${item.coins} xu) x ${item.quantity}</span>
                            <span>${formatPrice(itemTotal)}đ</span>
                        </div>
                    `;
                });
                
                let statusClass = '';
                let statusText = '';
                
                switch (order.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = 'Chờ xử lý';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = 'Hoàn thành';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = 'Đã hủy';
                        break;
                    default:
                        statusClass = 'status-pending';
                        statusText = 'Chờ xử lý';
                }
                
                html += `
                    <div class="order-card" data-status="${order.status}">
                        <div class="order-header">
                            <div>
                                <span class="order-id">Đơn hàng #${order.orderId}</span>
                                <span class="order-date">${order.date}</span>
                            </div>
                            <span class="order-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div>Tổng giá trị: <strong>${formatPrice(order.total)}đ</strong></div>
                        <div>Phương thức: ${getPaymentMethodName(order.paymentMethod)}</div>
                        
                        <div class="order-details">
                            ${itemsHtml}
                            <div class="order-total">Tổng cộng: ${formatPrice(order.total)}đ</div>
                        </div>
                        
                        <div class="view-details">Xem chi tiết <i class="fas fa-chevron-down"></i></div>
                    </div>
                `;
            });
            
            $('#orders-container').html(html);
        }

        // Xử lý khi click vào tab lịch sử
        $('#history-link').click(function(e) {
            e.preventDefault();
            
            // Ẩn tất cả các section khác
            $('section').hide();
            
            // Hiển thị section lịch sử
            $('#order-history').show();
            
            // Load đơn hàng
            loadOrderHistory();
            
            // Cuộn đến section
            $('html, body').animate({
                scrollTop: $('#order-history').offset().top - 80
            }, 500);
        });

        // Xử lý khi click vào tab trạng thái
        $(document).on('click', '.history-tab', function() {
            $('.history-tab').removeClass('active');
            $(this).addClass('active');
            
            const status = $(this).data('status');
            loadOrderHistory(status);
        });

        // Xử lý khi click xem chi tiết đơn hàng
        $(document).on('click', '.view-details', function() {
            const details = $(this).siblings('.order-details');
            const icon = $(this).find('i');
            
            if (details.is(':visible')) {
                details.slideUp();
                icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                details.slideDown();
                icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        });

        // [Giữ nguyên các hàm còn lại...]
    </script>
</body>
</html>
